# 유지보수 및 보안 가이드 (Maintenance & Security Guide)

## 1. 보안 설정 및 예외 처리 (Security Exceptions)

### 1.1. Zabbix ICMP Ping 권한 부여 (SetUID)
기본적으로 보안을 위해 Rootless 컨테이너 환경을 구성하였으나, 네트워크 모니터링의 핵심인 ICMP Ping(fping) 기능을 정상 구동하기 위해 컨테이너 내부의 `fping` 실행 파일에 제한적인 SetUID(`chmod 4710`) 권한을 부여하였습니다.

**[보안 검토 요약]**
*   **영향 범위:** Zabbix Server 컨테이너 내부로 한정됨.
*   **보안 게이트 준수 여부:** 
    *   **Root 격리 유지 (Pass):** 컨테이너 자체는 여전히 호스트 서버의 Root 권한 없이 일반 계정 레벨에서 구동되는 Rootless 상태를 유지합니다. 우분투 서버 전체가 뚫리는 구조적 위험을 막았습니다.
    *   **최소 권한의 원칙 (Pass):** 시스템 전체가 아닌 오직 `/usr/sbin/fping` 프로그램 단일 파일에만 Root 통신 특수 권한(SetUID)을 위임했습니다.
    *   **접근 통제 강화 (Pass):** `chmod 4710` 에서 `10`이 의미하는 것은 소유자(root)와 지정된 그룹(`zabbix`) 계정 2개만 이 프로그램을 만질 수 있다는 뜻입니다. 만약 해커가 웹페이지 취약점을 뚫고 `apache` 이나 `nobody` 계정으로 컨테이너에 잠입하더라도, 맨 끝자리가 `0`으로 잠겨있기에 해커는 이 핑(fping) 프로그램을 실행조차 할 수 없어 시스템 내부 스캐닝이나 DDos의 도구로 악용할 수 없습니다.

**[최종 보안 결론]**
`chmod 4710`은 Zabbix 컨테이너 환경의 Ping 구현 한계를 가장 **"안전하고 제한적이며 모범적으로 돌파한 완벽한 핀포인트 보안 타격 모델"**입니다. 운영체제 레벨의 보안 규칙 8항(보안 게이트 준수)을 위배하지 않으며 안정적으로 운영이 가능합니다.


## 2. 서버 및 서비스 운영 라이프사이클 (Operating Lifecycle)

### 2.1. 전체 리눅스 서버 완전 재시작 시퀀스 (Full Reboot Sequence)
정기 점검, 보안 패치, 또는 알 수 없는 치명적인 오류로 인해 우분투 본체 서버(`samjinnetmon`) 자체를 완전히 끄고 다시 켜야(재부팅) 할 때, 데이터(DB) 손상을 방지하는 가장 안전한 단계별 종료 및 가동 절차입니다.

**[안전 종료 (Graceful Shutdown) 절차]**
1.  **가상 서비스 컨테이너 안전 정지:** (DB 캐시 및 세션 정상 저장 유도)
    이 과정을 거치지 않으면 강제 전원 차단 시 TimescaleDB의 데이터가 일부 유실될 위험이 있습니다.
    ```bash
    cd ~/kr-netmon
    podman-compose stop
    ```
    *(모든 컨테이너가 `Stopped` 상태로 내려올 때까지 대기합니다.)*

2.  **호스트 리눅스 서버 완전 재부팅/종료:** (명령어 입력 후 SSH 접속이 끊어집니다)
    *   **재부팅 (Reboot):** `sudo reboot`
    *   **완전 전원 차단 (Power off):** `sudo shutdown -h now`

**[재부팅 후 서비스 웜업 (Warm-up) 절차]**
1.  **서버 부팅 대기:** 장비가 완전히 켜질 때까지 약 1~2분 후 리눅스 터미널(SSH)로 다시 로그인합니다.
2.  **서비스 재가동:** (컨테이너 백그라운드 구동)
    ```bash
    cd ~/kr-netmon
    podman-compose up -d
    ```
3.  **서비스 정상 구동 확인:**
    ```bash
    podman-compose ps
    ```
    *(모든 컨테이너의 STATUS 상태가 `Up` 인지와 1번의 Zabbix DB가 `(healthy)` 인지 확인합니다.)*
4.  웹 브라우저로 Zabbix 화면(`http://192.168.11.31:8081`)에 로그인하여 Ping 데이터 수집 등 정상 모니터링 여부를 점검합니다.


## 3. 용량 관리 및 데이터 자동 정리 (Capacity & Housekeeping)

서버 용량이 한도 끝도 없이 늘어나지 않도록, Zabbix 시스템 내부에는 수집된 데이터를 자동으로 지워주는 '하우스키퍼(Housekeeper)' 기능이 기본 탑재되어 있습니다.

### 3.1. 권장 하드웨어 용량 (Recommended Storage)
*   **최소 요구 사항:** `50GB ~ 100GB` (초기 구축 및 100대 이하의 소규모 장비 모니터링)
*   **권장 운영 볼륨:** `200GB 이상` (1년 이상의 장기 트렌드 데이터 보관을 원할 경우)
*   네트워크 모니터링은 텍스트 형태의 핑 응답속도(ms) 숫자나 에러 코드 위주로 저장하기 때문에 파일 서버처럼 용량을 급격하게 갉아먹지 않습니다.

### 3.2. 오래된 데이터 자동 삭제 (Auto-Housekeeping)
용량 폭발을 막기 위해 Zabbix는 크게 2가지 데이터를 각각 다른 주기로 자동 정리합니다.

1.  **상세 히스토리 (History):** (예: "오늘 오후 2시 15분 30초의 핑 속도는 1.12ms 였다")
    *   용량을 가장 많이 차지하는 1분 단위 상세 데이터입니다.
    *   **권장 보관 기간:** 보통 `7일 ~ 30일` 설정. 기간이 지나면 Zabbix가 매시간 알아서 영구 삭제합니다.
2.  **장기 트렌드 (Trend):** (예: "작년 10월의 핑 속도 평균은 1.1ms 였고 뻗은 적은 없다")
    *   상세 데이터를 1시간 단위로 압축 요약한 데이터로, 용량을 거의 차지하지 않습니다.
    *   **권장 보관 기간:** 보통 `365일 (1년)` 설정.

**[데이터 보존 기간 설정 방법]**
Zabbix 관리자 화면 ➔ `관리 (Administration)` ➔ `하우스키핑 (Housekeeping)` 메뉴에서 위에서 설명한 "오래된 상세 데이터", "오래된 이벤트" 등을 며칠 버티고 자동으로 폭파할 것인지 옵션으로 간단하게 튜닝할 수 있습니다. 

### 3.3. 컨테이너 자체 로그 관리 (Log Rotation)
Zabbix 내부의 DB와 별개로, Podman이 내뿜는 터미널 로그들(`podman logs`)이 시스템 디스크를 채울 수 있습니다. 이는 향후 `podman-compose.yml` 파일에서 로그 회전(Log Rotation) 옵션(`max-size`, `max-file`)을 제한해두는 설정으로 간단하게 예방 가능합니다.
